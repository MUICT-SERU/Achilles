import semver from 'semver'

export const filterRelatedVulnerabilities = (node: INode, vulnerabilities: ISecurityVulnerability[]) => {
  let relatedAdvisories: ISecurityVulnerability[] = []

  relatedAdvisories = vulnerabilities.filter((vulnerability) => {
    if (node.version !== 'latest') {
      const versionRange = vulnerability.vulnerableVersionRange && vulnerability.vulnerableVersionRange.toString().replace(',', '')

      if (semver.intersects(node.version, versionRange)) {
        if (vulnerability.firstPatchedVersion) {
          if (semver.intersects(node.version, vulnerability.firstPatchedVersion.identifier)) return false;
        } 
        return true;
      }
    }

    return false
  })

  return relatedAdvisories
}
